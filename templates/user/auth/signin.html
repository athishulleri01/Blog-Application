{% extends 'base.html' %} {% block title %}Login - BlogApp{% endblock %} {%
block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <div class="card shadow-sm">
        <div class="card-body p-5">
          <div class="text-center mb-4">
            <h2 class="h3 mb-3">Welcome back</h2>
            <p class="text-muted">Sign in to your account</p>
          </div>

          <form id="loginFormPage" method="post">
            {% csrf_token %}
            <div class="mb-3">
              <label for="id_username" class="form-label">Username</label>
              {{ form.username }} {% if form.username.errors %}
              <div class="invalid-feedback d-block">
                {{ form.username.errors.0 }}
              </div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label for="id_password" class="form-label">Password</label>
              {{ form.password }} {% if form.password.errors %}
              <div class="invalid-feedback d-block">
                {{ form.password.errors.0 }}
              </div>
              {% endif %}
            </div>

            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="rememberMe" />
              <label class="form-check-label" for="rememberMe">
                Remember me
              </label>
            </div>

            <button type="submit" class="btn btn-primary w-100 mb-3">
              <span
                class="spinner-border spinner-border-sm d-none me-2"
                role="status"
              ></span>
              <span class="btn-text">Sign in</span>
            </button>

            {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors.0 }}</div>
            {% endif %}
          </form>

          <div class="text-center">
            <p class="mb-0">
              Don't have an account?
              <a
                href="{% url 'accounts:register' %}"
                class="text-decoration-none"
                >Sign up</a
              >
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .card {
    border: none;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1) !important;
  }

  .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(26, 137, 23, 0.25);
  }

  .btn-primary {
    padding: 12px;
    font-weight: 500;
  }
</style>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const loginForm = document.getElementById("loginFormPage");
    if (loginForm) {
      loginForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const submitBtn = this.querySelector('button[type="submit"]');
        const formData = new FormData(this);

        BlogApp.setLoadingState(submitBtn, true);

        try {
          const response = await fetch("/accounts/ajax/login/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": BlogApp.getCsrfToken(),
            },
            body: JSON.stringify(Object.fromEntries(formData)),
          });

          const data = await response.json();

          if (data.success) {
            BlogApp.showNotification(data.message, "success");
            setTimeout(() => {
              window.location.href = data.redirect_url || "/";
            }, 1000);
          } else {
            if (data.errors) {
              // Show form errors
              for (const [field, messages] of Object.entries(data.errors)) {
                const fieldElement = this.querySelector(`[name="${field}"]`);
                if (fieldElement) {
                  fieldElement.classList.add("is-invalid");
                  const feedback =
                    fieldElement.parentNode.querySelector(
                      ".invalid-feedback"
                    ) || document.createElement("div");
                  feedback.className = "invalid-feedback d-block";
                  feedback.textContent = Array.isArray(messages)
                    ? messages[0]
                    : messages;
                  if (
                    !fieldElement.parentNode.querySelector(".invalid-feedback")
                  ) {
                    fieldElement.parentNode.appendChild(feedback);
                  }
                }
              }
            } else {
              BlogApp.showNotification(
                data.message || "Login failed",
                "danger"
              );
            }
          }
        } catch (error) {
          console.error("Error:", error);
          BlogApp.showNotification(
            "An error occurred. Please try again.",
            "danger"
          );
        } finally {
          BlogApp.setLoadingState(submitBtn, false);
        }
      });
    }
  });
</script>
{% endblock %}
